# SWE-bench Docker Architecture Documentation

## Overview

SWE-bench uses a containerized evaluation system to ensure reproducible results across different platforms. The Docker architecture consists of three image layers, each adding specific functionality for test execution.

## üèóÔ∏è 3-Layer Docker Architecture

### 1. Base Image
**Purpose**: Common dependencies for all evaluations  
**Contents**: 
- Ubuntu with basic system packages
- Git, wget, curl, build-essential
- Python 3 and pip
- Miniconda for Python environment management
- Nonroot user for security

**Python Example**:
```dockerfile
FROM --platform={platform} ubuntu:{ubuntu_version}
ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Etc/UTC

RUN apt update && apt install -y \
    wget git build-essential libffi-dev \
    python3 python3-pip python-is-python3 \
    jq curl locales tzdata

# Install Miniconda
RUN wget 'https://repo.anaconda.com/miniconda/Miniconda3-{conda_version}-Linux-{conda_arch}.sh' \
    && bash miniconda.sh -b -p /opt/miniconda3
ENV PATH=/opt/miniconda3/bin:$PATH
RUN conda init --all && conda config --append channels conda-forge

RUN adduser --disabled-password --gecos 'dog' nonroot
```

### 2. Environment Image
**Purpose**: Python environments for various configurations  
**Contents**:
- Inherits from base image
- Executes `setup_env.sh` for Python environment setup
- Creates conda environment "testbed"
- Automatically activates environment on startup

**Python Example**:
```dockerfile
FROM --platform={platform} {base_image_key}

COPY ./setup_env.sh /root/
RUN sed -i -e 's/\r$//' /root/setup_env.sh
RUN chmod +x /root/setup_env.sh
RUN /bin/bash -c "source ~/.bashrc && /root/setup_env.sh"

WORKDIR /testbed/

# Automatic testbed environment activation
RUN echo "source /opt/miniconda3/etc/profile.d/conda.sh && conda activate testbed" > /root/.bashrc
```

### 3. Instance Image
**Purpose**: Specific dependencies for each evaluation task  
**Contents**:
- Inherits from environment image
- Executes `setup_repo.sh` for repository cloning
- Installs specific project dependencies
- Configures working directory `/testbed`

**Python Example**:
```dockerfile
FROM --platform={platform} {env_image_name}

COPY ./setup_repo.sh /root/
RUN sed -i -e 's/\r$//' /root/setup_repo.sh
RUN /bin/bash /root/setup_repo.sh

WORKDIR /testbed/
```

## üîÑ Image Building Process

### Build Stages:

1. **Base Image Build**
   - Created for each platform (Linux x86_64, ARM64)
   - Installs common system dependencies
   - Configures Miniconda

2. **Environment Image Build**
   - Created based on base image
   - Executes `setup_env.sh` for Python setup
   - Creates conda environment "testbed"
   - Cached for reuse

3. **Instance Image Build**
   - Created for each evaluation instance
   - –ö–ª–æ–Ω–∏—Ä—É–µ—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø–∞—Ç—á –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º:

| –£—Ä–æ–≤–µ–Ω—å –∫—ç—à–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
|--------------|----------|---------------------|-------------------|
| `none` | –ë–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è | ~120GB –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | –°–∞–º–∞—è –º–µ–¥–ª–µ–Ω–Ω–∞—è |
| `base` | –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ | ~120GB –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | –ú–µ–¥–ª–µ–Ω–Ω–∞—è |
| `env` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) | –ë–∞–∑–æ–≤—ã–π + environment | ~100GB | –°—Ä–µ–¥–Ω—è—è |
| `instance` | –í—Å–µ –æ–±—Ä–∞–∑—ã | ~2,000GB | –°–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è |

## üöÄ –ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
```python
def run_instance(test_spec: TestSpec, pred: dict, ...):
    # –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    instance_id = test_spec.instance_id
    log_dir = RUN_EVALUATION_LOG_DIR / run_id / model_name / instance_id
    
    # –°–±–æ—Ä–∫–∞ instance image
    build_container(test_spec, pred, client, build_dir)
```

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ç—á–∞
```python
GIT_APPLY_CMDS = [
    "git apply --verbose",
    "git apply --verbose --reject", 
    "patch --batch --fuzz=5 -p1 -i",
]

# –ü–∞—Ç—á —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ /tmp/patch.diff
DOCKER_PATCH = "/tmp/patch.diff"
```

### 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
```python
# –¢–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ /testbed –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
DOCKER_WORKDIR = "/testbed"

# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
test_commands = test_spec.get_test_commands()
for cmd in test_commands:
    result = exec_run_with_timeout(container, cmd, timeout)
```

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```python
# –ê–Ω–∞–ª–∏–∑ –≤—ã–≤–æ–¥–∞ —Ç–µ—Å—Ç–æ–≤
test_output = container.exec_run("cat /testbed/test_output.txt")
test_results = parse_test_output(test_output)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
if ">>>>> All Tests Passed" in test_output:
    status = "PASSED"
elif ">>>>> Some Tests Failed" in test_output:
    status = "FAILED"
```

## üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–æ–≤:
```
logs/
‚îú‚îÄ‚îÄ build_images/
‚îÇ   ‚îú‚îÄ‚îÄ base/           # –õ–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –±–∞–∑–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ env/            # –õ–æ–≥–∏ —Å–±–æ—Ä–∫–∏ environment –æ–±—Ä–∞–∑–æ–≤  
‚îÇ   ‚îî‚îÄ‚îÄ instances/      # –õ–æ–≥–∏ —Å–±–æ—Ä–∫–∏ instance –æ–±—Ä–∞–∑–æ–≤
‚îú‚îÄ‚îÄ run_evaluation/     # –õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏
‚îî‚îÄ‚îÄ run_validation/     # –õ–æ–≥–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
```

### –ö–ª—é—á–µ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
- `>>>>> Applied Patch` - –ø–∞—Ç—á —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω
- `>>>>> Patch Apply Failed` - –æ—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ç—á–∞
- `>>>>> Init Succeeded` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
- `>>>>> All Tests Passed` - –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
- `>>>>> Some Tests Failed` - –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å
- `>>>>> Tests Timed Out` - —Ç–µ—Å—Ç—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ —Ç–∞–π–º–∞—É—Ç

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π

### –¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

1. **–ó–∞–≥—Ä—É–∑–∫–∞ data points**
   - JSON —Ñ–∞–π–ª—ã –∏–∑ `data_points/` –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
   - –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª–µ–π: `instance_id`, `patch`, `FAIL_TO_PASS`, `PASS_TO_PASS`

2. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ predictions**
   ```python
   prediction = {
       "instance_id": data_point["instance_id"],
       "model_name_or_path": "gold",  # –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ golden patches
       "model_patch": data_point["patch"]
   }
   ```

3. **–ó–∞–ø—É—Å–∫ –æ—Ü–µ–Ω–∫–∏**
   ```python
   from swebench.harness.run_evaluation import run_instance
   
   # –°–æ–∑–¥–∞–Ω–∏–µ TestSpec
   test_spec = make_test_spec(data_point)
   
   # –ó–∞–ø—É—Å–∫ –æ—Ü–µ–Ω–∫–∏
   result = run_instance(test_spec, prediction, ...)
   ```

4. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `FAIL_TO_PASS` —Ç–µ—Å—Ç–æ–≤ (–¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏ –ø–æ—Å–ª–µ –ø–∞—Ç—á–∞)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `PASS_TO_PASS` —Ç–µ—Å—Ç–æ–≤ (–¥–æ–ª–∂–Ω—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø—Ä–æ—Ö–æ–¥–∏—Ç—å)
   - –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

## ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ workers:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ–Ω—å—à–µ `min(0.75 * os.cpu_count(), 24)` workers
- –î–ª—è 8-—è–¥–µ—Ä–Ω–æ–π –º–∞—à–∏–Ω—ã: 6 workers
- –î–ª—è 16-—è–¥–µ—Ä–Ω–æ–π –º–∞—à–∏–Ω—ã: 12 workers

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏:
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Docker
docker system df

# –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
docker system prune -a

# –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
docker container prune  # –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker image prune      # –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
```

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫:
1. **–û—à–∏–±–∫–∏ —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤**
   - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
   - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–∫–µ—Ç–æ–≤
   - –û—à–∏–±–∫–∏ –≤ setup —Å–∫—Ä–∏–ø—Ç–∞—Ö

2. **–û—à–∏–±–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ç—á–∞**
   - –ü–∞—Ç—á –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é
   - –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å —Ç–µ–∫—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–æ–¥–∞

3. **–û—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤**
   - –¢–µ—Å—Ç—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç —Ç–∞–π–º–∞—É—Ç
   - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

SWE-bench Docker –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- **–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
- **–ò–∑–æ–ª—è—Ü–∏—é** –æ–∫—Ä—É–∂–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏ –æ—Ü–µ–Ω–∫–∏
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** —á–µ—Ä–µ–∑ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤

–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–æ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ SWE-bench data points –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö.

